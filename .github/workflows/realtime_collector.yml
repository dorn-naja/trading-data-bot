
name: Ultra Realtime Data Collector
permissions:
  contents: write

on:
  schedule:
    - cron: "* * * * *"     # ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
  workflow_dispatch:         # ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Actions

jobs:
  fetch_data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        pip install requests pandas sqlalchemy

    - name: Fetch realtime data
      run: |
        python - <<EOF
        import requests, pandas as pd, sqlite3, datetime, os, time

        print("=== ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ===")

        API_KEY = os.getenv("FINNHUB_API", "d2veodpr01qm5lo80ga0d2veodpr01qm5lo80gag")
        symbols = ["XAUUSD", "BTCUSD", "NDX", "EURUSD"]

        conn = sqlite3.connect("market_data.db")

        for s in symbols:
            try:
                url = f"https://finnhub.io/api/v1/quote?symbol={s}&token={API_KEY}"
                r = requests.get(url, timeout=10)
                data = r.json()

                if "c" in data:
                    df = pd.DataFrame([{
                        "symbol": s,
                        "price": data["c"],
                        "high": data["h"],
                        "low": data["l"],
                        "open": data["o"],
                        "prev_close": data["pc"],
                        "timestamp": datetime.datetime.utcnow().isoformat()
                    }])
                    df.to_sql("realtime_prices", conn, if_exists="append", index=False)
                    print(f"‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• {s} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
                else:
                    print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {s}")
            except Exception as e:
                print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î {s}: {e}")
                time.sleep(2)

        conn.close()
        print("=== ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ===")
        EOF

    - name: Manage old data
      run: |
        python - <<EOF
        import sqlite3, pandas as pd, datetime

        print("=== ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ===")
        now = datetime.datetime.utcnow()
        conn = sqlite3.connect("market_data.db")

        try:
            df = pd.read_sql("SELECT * FROM realtime_prices", conn)
        except Exception as e:
            print("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", e)
            conn.close()
            exit(0)

        df["timestamp"] = pd.to_datetime(df["timestamp"])
        one_year_ago = now - datetime.timedelta(days=365)
        three_years_ago = now - datetime.timedelta(days=365*3)

        # ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏õ‡∏µ‡πÑ‡∏õ summary
        old_data = df[df["timestamp"] < one_year_ago]
        if not old_data.empty:
            print("üì¶ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏õ‡∏µ‡πÑ‡∏õ‡∏¢‡∏±‡∏á daily_summary.db")
            daily = old_data.groupby([df["symbol"], df["timestamp"].dt.date]).agg({
                "price": "mean", "high": "max", "low": "min",
                "open": "first", "prev_close": "last"
            }).reset_index()
            conn2 = sqlite3.connect("daily_summary.db")
            daily.to_sql("daily_prices", conn2, if_exists="append", index=False)
            conn2.close()

        # ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏õ‡∏µ
        df_new = df[df["timestamp"] >= three_years_ago]
        df_new.to_sql("realtime_prices", conn, if_exists="replace", index=False)
        conn.close()
        print("‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")
        EOF

    - name: Commit and push updated data
      run: |
        git config --global user.name "dorn-naja"
        git config --global user.email "dornnaja023@gmail.com"
        git add market_data.db daily_summary.db || true
        git commit -m "Update realtime market data" || true
        git push
