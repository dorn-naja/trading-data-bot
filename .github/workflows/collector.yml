name: Collect Trading Data

on:
  schedule:
    - cron: "0 */1 * * *"  # ดึงข้อมูลทุก 1 ชั่วโมง
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install yfinance pandas sqlite-utils

      - name: Run data collector
        run: |
          python - <<'EOF'
          import yfinance as yf
          import sqlite3, datetime

          assets = {
              "GOLD": "GC=F",
              "BTC": "BTC-USD",
              "NASDAQ": "^NDX",
              "EURUSD": "EURUSD=X"
          }

          conn = sqlite3.connect("market_data.db")
          cur = conn.cursor()
          cur.execute("""
          CREATE TABLE IF NOT EXISTS prices (
              asset TEXT,
              datetime TEXT,
              open REAL, high REAL, low REAL, close REAL, volume REAL
          )
          """)

          for name, symbol in assets.items():
              data = yf.download(symbol, period="3y", interval="1h")
              for dt, row in data.iterrows():
                  cur.execute("INSERT INTO prices VALUES (?,?,?,?,?,?,?)",
                              (name, dt.isoformat(), row['Open'], row['High'], row['Low'], row['Close'], row['Volume']))
              print(f"✅ Saved {name}")

          conn.commit()
          conn.close()
          print("✅ Done collecting data.")
          EOF
